# Configuration System

This document explains how the ESP-IDF configuration system works in this project.

## Overview

ESP-IDF uses a Kconfig-based configuration system with three main components:

1. **`Kconfig.projbuild`** - Defines available configuration options (the schema)
2. **`sdkconfig.defaults`** and **`sdkconfig.wokwi`** - Set values for those options (presets)
3. **`sdkconfig`** (auto-generated) - Final configuration file used during build

## How It Works

### Configuration Flow

```
Kconfig.projbuild (defines options) → sdkconfig.defaults (custom values) → sdkconfig (final result)
                                                                                ↓
                                                                    Runtime: NVS (persistent storage)
                                                                                ↓
                                                                    BLE Configuration Service (optional)
```

The system supports two configuration approaches:

1. **Build-time configuration**: Using Kconfig/sdkconfig files (WiFi, NTP, timezone, etc.)
2. **Runtime configuration**: Using BLE to update settings stored in NVS

### Runtime Configuration via BLE

The device exposes BLE GATT services that allow updating configuration at runtime:

- **Network Service** (UUID: 0x00FF)
  - WiFi SSID: Characteristic 0xFF01
  - WiFi Password: Characteristic 0xFF02
  - WiFi Auth Mode: Characteristic 0xFF03

- **Clock Service** (UUID: 0x01FF)
  - Time format (12h/24h): Characteristic 0xFF11
  - Show seconds toggle: Characteristic 0xFF12

- **NTP Service** (UUID: 0x02FF)
  - Timezone: Characteristic 0xFF21
  - NTP Server 1: Characteristic 0xFF22
  - NTP Server 2: Characteristic 0xFF23
  - Sync Interval: Characteristic 0xFF24

- **Language Service** (UUID: 0x03FF)
  - Language: Characteristic 0xFF31

- **Weather Service** (UUID: 0x04FF)
  - API key: Characteristic 0xFF41
  - Location: Characteristic 0xFF42

Configuration changes made via BLE are:
1. Immediately applied to the running system
2. Stored in NVS (persistent across reboots)
3. Override build-time Kconfig defaults

**Priority hierarchy** (highest to lowest):
1. NVS (runtime configuration via BLE)
2. `sdkconfig.local` (developer overrides)
3. `sdkconfig.defaults` (committed defaults)
4. `Kconfig.projbuild` (schema defaults)

### Important Rules

**CRITICAL:** Every configuration option (`CONFIG_*`) used in your C code **MUST** be defined in a `Kconfig` file first.

- ✅ **Correct**: Define option in `Kconfig.projbuild`, optionally override value in `sdkconfig.*`
- ❌ **Wrong**: Only add `CONFIG_*` to `sdkconfig.*` without defining it in `Kconfig.projbuild`

### Why This Matters

If you add `CONFIG_MY_OPTION=123` to `sdkconfig.defaults` but don't define it in `Kconfig.projbuild`:
- The option will be **ignored** by the build system
- It won't be available as a macro in your C code
- You'll get "undeclared identifier" compile errors

### Example

#### 1. Define in `main/Kconfig.projbuild`:
```kconfig
config TIMEMACHINE_WIFI_AUTHMODE
    int "WiFi Authentication Mode"
    default 3
    help
        WiFi authentication mode (integer value from wifi_auth_mode_t enum).
        0 = WIFI_AUTH_OPEN (no password)
        3 = WIFI_AUTH_WPA2_PSK (WPA2 with password)
```

#### 2. Override value in `sdkconfig.defaults` (optional):
```
CONFIG_TIMEMACHINE_WIFI_AUTHMODE=3
```

#### 3. Use in C code:
```c
wifi_config_t wifi_config = {
    .sta = {
        .threshold.authmode = CONFIG_TIMEMACHINE_WIFI_AUTHMODE,
    },
};
```

## Configuration Files

### `main/Kconfig.projbuild`
- Defines all project-specific configuration options
- Sets default values and types (int, string, bool)
- Provides help text for each option
- Located in the `main` component directory

### `sdkconfig.defaults`
- Production/default configuration values (committed to git)
- Used when building for real hardware
- Overrides Kconfig defaults
- Should contain sensible defaults for the project

### `sdkconfig.local` (optional, developer overrides)
- **Local personal settings** (not committed to git, add to .gitignore)
- Overrides values from `sdkconfig.defaults`
- Perfect for personal settings like WiFi credentials
- To use: `export SDKCONFIG_DEFAULTS="sdkconfig.defaults;sdkconfig.local"`

**Example `sdkconfig.local`:**
```
# Personal WiFi credentials
CONFIG_TIMEMACHINE_WIFI_SSID="MyHomeNetwork"
CONFIG_TIMEMACHINE_WIFI_PASSWORD="mypassword123"

# Personal timezone
CONFIG_TIMEMACHINE_TIMEZONE="<-03>3"
```

**Usage:**
```bash
# Set environment variable (add to ~/.zshrc or ~/.bashrc)
export SDKCONFIG_DEFAULTS="sdkconfig.defaults;sdkconfig.local"

# Build normally
idf.py build
```

### `sdkconfig.wokwi`
- Configuration for Wokwi simulator
- Use with: `idf.py -DSDKCONFIG_DEFAULTS=sdkconfig.wokwi build`

### `sdkconfig` (auto-generated)
- **Do not edit manually**
- Generated by the build system
- Combines Kconfig definitions with your defaults
- Git-ignored by default

## Best Practices

1. **Always define in Kconfig first** - Before using any `CONFIG_*` in code
2. **Use meaningful defaults** - Set sensible defaults in `Kconfig.projbuild`
3. **Document enum values** - When using int configs for enums, document the mapping
4. **Keep presets minimal** - Only override in `sdkconfig.*` when needed
5. **Clean build after Kconfig changes** - Run `idf.py fullclean` after modifying `Kconfig.projbuild`

## Troubleshooting

### "undeclared identifier" errors for CONFIG_*

**Cause:** The configuration is not defined in any `Kconfig` file.

**Solution:** Add the configuration definition to `main/Kconfig.projbuild`, then run:
```bash
idf.py fullclean
idf.py build
```

### Configuration value not being applied

**Cause:** Either the Kconfig definition is missing, or `sdkconfig` needs regeneration.

**Solution:**
```bash
rm -rf build sdkconfig
idf.py build
```

## More Information

- [ESP-IDF Project Configuration](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/kconfig.html)
- [Kconfig Language](https://www.kernel.org/doc/html/latest/kbuild/kconfig-language.html)
